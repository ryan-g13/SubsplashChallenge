// let results =  require('./results');
let results = {"count":20,"total":12846,"_embedded":{"media-items":[{"_links":{"self":{"href":"https://challenge.subsplash.net/challenge/v1/youtube?filter[id]=087be799-9f63-4f80-adaa-7374f44cfdf5"}},"id":"087be799-9f63-4f80-adaa-7374f44cfdf5","title":"Dia 31 - As sand├ílias","youtube_url":"https://www.youtube.com/watch?v=r-Hj0__bGBI","reach":502011,"published_at":"2018-05-01T15:31:11Z"},{"_links":{"self":{"href":"https://challenge.subsplash.net/challenge/v1/youtube?filter[id]=87adc1f4-b9dc-48bb-90f3-b4a9c13b22c8"}},"id":"87adc1f4-b9dc-48bb-90f3-b4a9c13b22c8","title":"Romans 1:18-25","youtube_url":"https://www.youtube.com/watch?v=Kc5bmv1NH6c","reach":502011,"published_at":"2018-05-01T13:31:35Z"},{"_links":{"self":{"href":"https://challenge.subsplash.net/challenge/v1/youtube?filter[id]=eca85c1d-66aa-4e4c-b1cb-750f5d2a25fc"}},"id":"eca85c1d-66aa-4e4c-b1cb-750f5d2a25fc","title":"Matthew 21a","youtube_url":"https://www.youtube.com/watch?v=YV_3l6Ng5lA","reach":502011,"published_at":"2018-04-30T20:52:18Z"},{"_links":{"self":{"href":"https://challenge.subsplash.net/challenge/v1/youtube?filter[id]=0c8c8e24-2237-4887-99a6-9dcb263364a2"}},"id":"0c8c8e24-2237-4887-99a6-9dcb263364a2","title":"Identity Lost and Restored","youtube_url":"https://www.youtube.com/watch?v=loO_BSjAZ0Y","reach":502011,"published_at":"2018-04-30T18:47:18Z"},{"_links":{"self":{"href":"https://challenge.subsplash.net/challenge/v1/youtube?filter[id]=a0df5db8-2021-4ac3-8fa7-3dcc63a22536"}},"id":"a0df5db8-2021-4ac3-8fa7-3dcc63a22536","title":"Jesus the One and Only","youtube_url":"https://www.youtube.com/watch?v=AeF72myS8L8","reach":192408,"published_at":"2018-04-30T18:21:49Z"},{"_links":{"self":{"href":"https://challenge.subsplash.net/challenge/v1/youtube?filter[id]=69ec91a7-5beb-413e-8133-60298ef41a82"}},"id":"69ec91a7-5beb-413e-8133-60298ef41a82","title":"Our Church","youtube_url":"https://www.youtube.com/watch?v=Of83wKb0nQM","reach":960261,"published_at":"2018-04-30T16:47:36Z"},{"_links":{"self":{"href":"https://challenge.subsplash.net/challenge/v1/youtube?filter[id]=b129f1af-3082-4291-8322-c1ec2723d947"}},"id":"b129f1af-3082-4291-8322-c1ec2723d947","title":"You Can Come Back Even When You're Worn Down","youtube_url":"https://www.youtube.com/watch?v=NRcs5Ji3d-0","reach":793715,"published_at":"2018-04-30T15:47:31Z"},{"_links":{"self":{"href":"https://challenge.subsplash.net/challenge/v1/youtube?filter[id]=8d0f736b-2f86-4360-baae-a93ff0d035d5"}},"id":"8d0f736b-2f86-4360-baae-a93ff0d035d5","title":"Frequency - Week 1","youtube_url":"https://www.youtube.com/watch?v=bVuFBekMDu8","reach":300563,"published_at":"2018-04-30T15:24:18Z"},{"_links":{"self":{"href":"https://challenge.subsplash.net/challenge/v1/youtube?filter[id]=48cfa830-e3f5-43f1-9c73-37ee92425195"}},"id":"48cfa830-e3f5-43f1-9c73-37ee92425195","title":"Do Not Be Anxious","youtube_url":"https://www.youtube.com/watch?v=4xg7UYXRTNo","reach":903356,"published_at":"2018-04-30T13:03:23Z"},{"_links":{"self":{"href":"https://challenge.subsplash.net/challenge/v1/youtube?filter[id]=4df67680-f25c-4014-9e25-e01cb21c42c4"}},"id":"4df67680-f25c-4014-9e25-e01cb21c42c4","title":"Fasting","youtube_url":"https://www.youtube.com/watch?v=aYfk_FmBpac","reach":700615,"published_at":"2018-04-30T13:02:28Z"},{"_links":{"self":{"href":"https://challenge.subsplash.net/challenge/v1/youtube?filter[id]=7c546b8e-8e41-4da6-9532-7692f0ec2802"}},"id":"7c546b8e-8e41-4da6-9532-7692f0ec2802","title":"He Is Greater Than I","youtube_url":"https://www.youtube.com/watch?v=6QGAlihHlf8\u0026t=2s","reach":554653,"published_at":"2018-04-30T13:00:45Z"},{"_links":{"self":{"href":"https://challenge.subsplash.net/challenge/v1/youtube?filter[id]=cce81f9b-ac5a-43c9-b407-372c7573222b"}},"id":"cce81f9b-ac5a-43c9-b407-372c7573222b","title":"Dia 30 - H├í comida de sobra na casa do Pai","youtube_url":"https://www.youtube.com/watch?v=qjXeU4zxeGU","reach":400949,"published_at":"2018-04-30T11:35:43Z"},{"_links":{"self":{"href":"https://challenge.subsplash.net/challenge/v1/youtube?filter[id]=d97e1429-8473-4595-bc9d-f806d84ce151"}},"id":"d97e1429-8473-4595-bc9d-f806d84ce151","title":"Callings, Crowds \u0026 Coffins","youtube_url":"https://www.youtube.com/watch?v=zSp0blGcnzw","reach":246604,"published_at":"2018-04-29T23:43:22Z"},{"_links":{"self":{"href":"https://challenge.subsplash.net/challenge/v1/youtube?filter[id]=5f4ef4db-e13d-45a4-ae1a-e3eb74876d88"}},"id":"5f4ef4db-e13d-45a4-ae1a-e3eb74876d88","title":"Even When We're Persecuted","youtube_url":"https://www.youtube.com/watch?v=23iWSdQA_n4","reach":994954,"published_at":"2018-04-29T18:22:30Z"},{"_links":{"self":{"href":"https://challenge.subsplash.net/challenge/v1/youtube?filter[id]=9222cf11-e772-40f0-97f1-fda6894cf182"}},"id":"9222cf11-e772-40f0-97f1-fda6894cf182","title":"Our Journey Home ΓÇô Exodus: Teaching on Christ (copy)","youtube_url":"https://www.youtube.com/watch?v=ZKsN-AeqJP0","reach":618837},{"_links":{"self":{"href":"https://challenge.subsplash.net/challenge/v1/youtube?filter[id]=10a5d684-6d9c-4754-8a44-dc979c82cc6c"}},"id":"10a5d684-6d9c-4754-8a44-dc979c82cc6c","title":"The Secret Of Marriage ΓÇô Jason Kimbrow","youtube_url":"https://www.youtube.com/watch?v=e2h0L0VVIos","reach":336259,"published_at":"2018-04-29T17:31:43Z"},{"_links":{"self":{"href":"https://challenge.subsplash.net/challenge/v1/youtube?filter[id]=ede7c1de-bb17-43da-b77e-db269541f6ed"}},"id":"ede7c1de-bb17-43da-b77e-db269541f6ed","title":"The Encounter (Part 9)","youtube_url":"http://www.youtube.com/pastorroncarpenter","reach":632375,"published_at":"2018-04-29T15:23:45Z"},{"_links":{"self":{"href":"https://challenge.subsplash.net/challenge/v1/youtube?filter[id]=3cc064a6-7359-4cae-8840-ecfb2a26b7f5"}},"id":"3cc064a6-7359-4cae-8840-ecfb2a26b7f5","title":"Judgment In Exile","youtube_url":"https://www.youtube.com/watch?v=lrnSyZ0RUaI\u0026feature=youtu.be","reach":761757,"published_at":"2018-04-29T14:44:38Z"},{"_links":{"self":{"href":"https://challenge.subsplash.net/challenge/v1/youtube?filter[id]=1d51651a-8ec4-4eec-8b2a-a8c98c0efa46"}},"id":"1d51651a-8ec4-4eec-8b2a-a8c98c0efa46","title":"Dia 29 - O reencontro - Semana 5","youtube_url":"https://www.youtube.com/watch?v=T79vgg7IRB8","reach":629324,"published_at":"2018-04-29T13:07:39Z"},{"_links":{"self":{"href":"https://challenge.subsplash.net/challenge/v1/youtube?filter[id]=e156230a-ba16-443c-9002-037dd4c133f9"}},"id":"e156230a-ba16-443c-9002-037dd4c133f9","title":"Dia 28 - A casa do pai","youtube_url":"https://www.youtube.com/watch?v=kEc1eFIdiG0","reach":460206,"published_at":"2018-04-28T13:30:26Z"}]}};

let https = require('https');
/*
let options = {
  host: 'challenge.subsplash.net',
  port: 443,
  method: 'GET',
  headers: {
    "Cache-Control": "no-cache",
    "X-Sap-Auth": 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJlN2U5NDhlOC0xMzA3 LTRhNDktOTkzZS1jZDQwMGIyNDBiNzMiLCJpYXQiOjE1MTc0NDMyMDB9.c CnoZDiDA1wZDw2jrbRgpwWvtA5nHHaDaUKLl1fAXAY'
  },
  ALPNProtocols: ["http/1.1"], // Tried different permutations still did not work.
};

var req = https.request(options, function(res) {
  console.log('STATUS: ' + res.statusCode);
  console.log('HEADERS: ' + JSON.stringify(res.headers));
  res.setEncoding('utf8');
  res.on('data', function (chunk) {
    console.log('BODY: ' + chunk);
  });
});

req.on('error', function(e) {
  console.log('problem with request: ' + e.message);
});

// write data to request body
req.write('data\n');
req.end();
*/

// -----------------------------------------------------------------------------------------------
// Parsing the object being returned from the API - currently importing manually as a JSON object. 
/* Array of objects that holds the following information
Title => _embedded.media-items[0].title 
youtube_url = videoUrl, _embedded.media-items[0].youtube_url 
Reach per video =>  _embedded.media-items[0].reach 
*/
// -----------------------------------------------------------------------------------------------
let subSplashResults = [];
results = results._embedded["media-items"];
results.forEach(element => {
  element.duration = '';
  element.views = '';
  subSplashResults.push(element);
});

// Loop to retrieve relevant YT fields for each object in the array.
function pingYT() {
  // const combinedArray = subSplashResults.map( () => {        /// idea to try to add the views and duration to objects
  for(let i = 0; i < subSplashResults.length; i++ ) {
    if(subSplashResults[i].youtube_url.slice(-13, -11) !== 'v=') {
      continue;
    }
    var req = https.get(`https://www.googleapis.com/youtube/v3/videos?part=snippet%2C+contentDetails%2C+statistics&id=${subSplashResults[i].youtube_url.slice(-11)}&key=AIzaSyBWUFr0py0ypP4G_XYeNsez-JqPCT1jwoI`, function (res) {
      let chunks = [];

      res.on("data", function (chunk) {
        chunks.push(chunk);
      });

      res.on("end", function () {
        let body = Buffer.concat(chunks);
        let bodyString = JSON.parse(body);
        subSplashResults[i].duration = bodyString.items[0].contentDetails.duration;
        subSplashResults[i].views = bodyString.items[0].statistics.viewCount;
      });
    });

    req.end();
  }
  return subSplashResults;
}

// -----------------------------------------------------------------------------------------------
/*
3. Filter results by videos that are of Duration > 45 min && parse the string value for H or trim PT and check next 2 chars of string.  
4. Print output to the Table.
*/
// let tableArray = Table to be printed 
// 45 min = 2700000ms

function compare(a, b) {
  const reachA = a.reach;
  const reachB = b.reach;
  
  let comparison = 0;
  if (reachA < reachB) {
    comparison = 1;
  } else if (reachA > reachB) {
    comparison = -1;
  }
  return comparison;
}

const tableArray = subSplashResults.sort(compare);

console.log(tableArray);
// const tableArray = subSplashResults.filter(item => item.reach > 100);

// -----------------------------------------------------------------------------------------------
// Appending elements to the HTML document
// -----------------------------------------------------------------------------------------------
// let tablerow = document.getElementById(`row${1}`).firstChild();
// // let node = document.createTextNode('TD');
// tablerow.appendChild(tableArray[0].title);

// -----------------------------------------------------------------------------------------------
// Function Calls 
pingYT();